<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>${IDENTITY_NAME} Hashing Tool</title>
    <link rel="stylesheet" type="text/css" href="./app.css" />
    <script src="${UID_JS_SDK_URL}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <script>
    // __uid2 for UID2 SDK, __euid for EUID SDK
    const sdkName = '${UID_JS_SDK_NAME}';
    let hasResults = false;
    
    // Helper object is named __uid2Helper or __euidHelper based on SDK
    function getHelper() {
      return window[sdkName + 'Helper'];
    }
    
    async function updateGuiElements(normalizedInput, inputType) {
      const helper = getHelper();

      if (normalizedInput && helper) {
        const hashedValue = await helper.hashIdentifier(normalizedInput);
        $('#hashed').text(hashedValue);
        const encodedValue = await helper.hashAndEncodeIdentifier(normalizedInput);
        $('#base64_encoded').text(encodedValue);
        hasResults = true;
        updateButtonState();
      }
      else {
        $('#hashed').text(' ');
        $('#base64_encoded').text(' ');
        if (inputType === "email") {
          $("#normalization_value").text(' ');
          $('#alert_box_email').show();
        }
        else if (inputType === "mobile") {
          $('#alert_box_mobile').show();
        }
      }
    }

    function clearElements() {
      document.querySelector('#input_value').value = "";
      $('#normalization_value').text(' ');
      $('#hashed').text(' ');
      $('#base64_encoded').text(' ');
      $('.alert').hide();
      hasResults = false;
      updateButtonState();
    }

    function updateButtonState() {
      if (hasResults) {
        $('#action_btn').text('Clear');
        $('#input_form').hide();
        $('#clear_form').show();
      } else {
        $('#action_btn').text('Enter');
        $('#input_form').show();
        $('#clear_form').hide();
      }
    }

    function onDocumentReady() {
        clearElements();
        document.querySelector('#input_value').placeholder = "Enter an email address";
        
        $('#enter_btn').click(handleEnter);
        $('#clear_btn').click(clearElements);
    }

    function handleRadioClick(radioButton) {
      clearElements();
      const inputType = radioButton.value;
      let placeholder = "";
      if (inputType == "email") {
        placeholder = "Enter an email address";
        $('#normalization').show();
      } 
      else if (inputType == "mobile") {
        placeholder = "Enter a phone number";
        $('#normalization').hide();
      } 
      document.querySelector('#input_value').placeholder = placeholder;
    }

    async function handleEnter() {
        $('.alert').hide();
        const inputValue = $('#input_value').val();
        const inputType = document.querySelector('input[name="toggle_input_type"]:checked').value;
        const helper = getHelper();
        let normalizedInput = undefined;
        
        if (!helper) {
          console.error('SDK helper not loaded yet');
          return;
        }
        
        if (inputType == "mobile") {
          const isNormalizedPhone = helper.isNormalizedPhone(inputValue)
          if (isNormalizedPhone) {
            normalizedInput = inputValue;
          }
        }
        if (inputType === "email") {
          normalizedInput = helper.normalizeEmail(inputValue);
          $('#normalization_value').text(normalizedInput);
        }
        updateGuiElements(normalizedInput, inputType);
    }

    $(document).ready(onDocumentReady);

  </script>
  <body>
    <div class="page-wrapper">
      <!-- Main Content Area -->
      <div class="main-content">
        <h1>${IDENTITY_NAME} Hashing Tool</h1>
        <p class="intro">
          Use this tool to verify that your own implementation is normalizing and 
          encoding correctly. Choose Email or Phone Number, then type or paste the
          value and click Enter. For documentation, see 
          <a href="${DOCS_BASE_URL}/getting-started/gs-normalization-encoding" target="_blank">Normalization and Encoding</a>.
          [<a href="https://github.com/IABTechLab/uid2-examples/tree/main/tools/hashing-tool">Source Code</a>]
        </p>

        <!-- Input Form -->
        <div id="input_form" class="form top-form">
          <div class="input-type-toggle">
            <input type="radio" id="toggle_email" name="toggle_input_type" value="email" onclick="handleRadioClick(this)" checked>
            <label for="toggle_email">Email</label>
            <input type="radio" id="toggle_mobile" name="toggle_input_type" value="mobile" onclick="handleRadioClick(this)">
            <label for="toggle_mobile">Phone Number</label>
          </div>
          
          <div class="email_prompt">
            <input
              type="text"
              id="input_value"
              name="input_value"
              placeholder=""
            />
            <button type="button" class="button" id="enter_btn">Enter</button>
          </div>

          <div class="alert" id="alert_box_email">
            <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
            Email format is invalid.
          </div>
          <div class="alert" id="alert_box_mobile">
            <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
            Phone number format is invalid or is not normalized.
          </div>
        </div>

        <!-- Clear Form (shown after results) -->
        <div id="clear_form" style="display: none" class="form top-form">
          <button type="button" class="button" id="clear_btn">Clear</button>
        </div>

        <h2>Results</h2>
        
        <table id="results_table">
          <tr id="normalization">
            <td class="label">
              <div class="tooltip-wrapper">
                Normalized Value:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The email after normalization: lowercase, trimmed, and for Gmail addresses, periods removed and plus-addressing stripped.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="normalization_value"> </pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Hashed Value:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The 64-character hex-encoded SHA-256 hash of the normalized value. This is an intermediate stepâ€”use the Base64-encoded value for API calls.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="hashed"> </pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Base64-encoded Value:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The 44-character Base64-encoded representation of the SHA-256 hash bytes. This is the value to send to ${IDENTITY_NAME} API endpoints.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="base64_encoded"> </pre></td>
          </tr>
        </table>
      </div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <h3>ðŸ“‹ Why Hash?</h3>
        
        <div class="section">
          <h4>Privacy & Security</h4>
          <ul>
            <li>Hashing converts email/phone into an opaque value</li>
            <li>Original data cannot be recovered from the hash</li>
            <li>${IDENTITY_NAME} never sees raw user data</li>
          </ul>
        </div>

        <div class="section">
          <h4>Normalization is Required</h4>
          <ul>
            <li>Ensures consistent ${IDENTITY_NAME}s across systems</li>
            <li><strong>Email:</strong> Lowercase, trim spaces, Gmail special handling</li>
            <li><strong>Phone:</strong> E.164 format required (e.g., +12345678901)</li>
          </ul>
        </div>

        <div class="section">
          <h4>Common Mistakes</h4>
          <ul>
            <li>Hashing without normalizing first</li>
            <li>Using hex hash instead of Base64</li>
            <li>Not normalizing phone numbers</li>
          </ul>
        </div>

        <div class="note">
          <strong>Important:</strong> Phone numbers must be normalized to E.164 format <em>before</em> using this tool. The tool normalizes emails automatically but cannot normalize phone numbers.
        </div>

        <div class="section" style="margin-top: 1.5rem;">
          <h4>Documentation</h4>
          <ul>
            <li><a href="${DOCS_BASE_URL}/getting-started/gs-normalization-encoding" target="_blank">Normalization Guide</a></li>
            <li><a href="${DOCS_BASE_URL}/getting-started/gs-normalization-encoding#email-address-hash-encoding" target="_blank">Email Hash Encoding</a></li>
            <li><a href="${DOCS_BASE_URL}/getting-started/gs-normalization-encoding#phone-number-hash-encoding" target="_blank">Phone Hash Encoding</a></li>
          </ul>
        </div>
      </aside>
    </div>
  </body>
</html>
