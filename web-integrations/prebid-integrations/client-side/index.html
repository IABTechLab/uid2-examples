<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Client-Side ${IDENTITY_NAME} SDK Integration Example with Prebid.js</title>
    <link rel="stylesheet" type="text/css" href="./app.css" />
    <link rel="shortcut icon" href="/img/favicon.ico" />
    <script async src="../prebid.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      console.log('Initializing example.')

      const identityName = '${IDENTITY_NAME}';  // 'UID2' or 'EUID'
      const apiBaseKey = identityName === 'EUID' ? 'euidApiBase' : 'uid2ApiBase';
      const userIdName = identityName.toLowerCase();  // 'uid2' or 'euid'

      function updateGuiElements() {
        console.log('Updating displayed values.');
        const identity = pbjs.getUserIds()[userIdName];
        console.log('Identity:', identity);
        
        let isOptedOut = false;
        const storedToken = localStorage.getItem('${UID_STORAGE_KEY}');
        if (storedToken) {
          try {
            const tokenData = JSON.parse(storedToken);
            isOptedOut = tokenData.latestToken === 'optout';
          } catch (e) {
            console.log('Could not parse stored token');
          }
        }
        
        $('#targeted_advertising_ready').text(identity ? 'yes' : 'no');
        
        if (isOptedOut) {
          $('#advertising_token').text('This email has opted out.');
          $('#login_form').hide();
          $('#clear_storage_form').show();
        } else {
          $('#advertising_token').text(identity ? String(identity.id) : '');
          if (!identity) {
            $('#login_form').show();
            $('#clear_storage_form').hide();
          } else {
            $('#login_form').hide();
            $('#clear_storage_form').show();
          }
        }
      }

      async function handleLogin() {
        const email = $('#email').val();
        setUidConfig(email);
        await pbjs.refreshUserIds();
        updateGuiElements();
      }

      function handleClearStorage() {
        console.log('Clearing storage.');
        localStorage.removeItem('${UID_STORAGE_KEY}');
        location.reload();
      }

      function onDocumentReady() {
        console.log('Setting up interface handlers.');
        $('#login').click(handleLogin);
        $('#clear_storage').click(handleClearStorage);
        
        updateGuiElements();
      }

      function setUidConfig(email) {
        const uidParams = email ? {
          [apiBaseKey]: '${BASE_URL}',
          email,
          subscriptionId: '${SUBSCRIPTION_ID}',
          serverPublicKey: '${SERVER_PUBLIC_KEY}',
        } : {
          [apiBaseKey]: '${BASE_URL}',
        };
        
        const config = {
          debug: true,
          userSync: {
            userIds: [
              {
                name: userIdName,
                params: uidParams,
              },
            ],
            syncDelay: 5000,
            auctionDelay: 1000,
          },
        };
        
        // Only add consent management for EUID (GDPR compliance)
        if (identityName === 'EUID') {
          config.consentManagement = consentManagementObj;
        }
        
        pbjs.setConfig(config);
      }

      // Consent management for GDPR compliance (required for EUID)
      const consentManagementObj = {
        "cmpApi": "static",
        "consentData": {
          "getTCData": {
            "tcString": "CO-HDlqO-HDlqAKAXCENBDCsAP_AAH_AACiQHKNd_X_fb39j-_59_9t0eY1f9_7_v20zjgeds-8Nyd_X_L8X42M7vF36pq4KuR4Eu3LBIQFlHOHcTUmw6IkVqTPsak2Mr7NKJ7PEinMbe2dYGHtfn9VTuZKYr97s___z__-__v__75f_r-3_3_vp9V---_fA5QAkw1L4CLMSxwJJo0qhRAhCuJDoAQAUUIwtE1hASuCnZXAR-ggYAIDUBGBECDEFGLIIAAAAAkoiAkAPBAIgCIBAACAFSAhAARoAgsAJAwCAAUA0LACKAIQJCDI4KjlMCAiRaKCeSMASi72MMIQyigBoFH4AAAAA.cAAAAAAAAAAA",
            "cmpId": 10,
            "cmpVersion": 23,
            "tcfPolicyVersion": 2,
            "gdprApplies": true, 
            "cmpStatus": "loaded",
            "eventStatus": "tcloaded",
            "purpose": {
              "consents": {
                "1": true,
                "2": true
              }
            },
            "vendor": {
              "consents": {
                "52": true,     // rubicon for adserving
                "21": true,     // unifiedId
                "131": true,    // id5Id
                "929": true,    // parrableId
                "97": true,     // identityLink
                "887": true,    // uid2
                "95": true,     // lotamePanoramaId
                "301": true,    // zeotapIdPlus
                "91": true,     // criteo
                "737": true,    // amxId
                "58": true,     // 33acrossId
              }
            }
          }
        }
      };

      var adUnits = [
        {
          code: 'test-div',
          mediaTypes: {
            banner: {
              sizes: [
                [300, 250],
                [300, 600],
                [728, 90],
              ],
            },
          },
          bids: [
            {
              bidder: 'appnexus',
              params: {
                placementId: 13144370,
              },
            },
          ],
        },
      ];

      var pbjs = pbjs || {};
      pbjs.que = pbjs.que || [];
      pbjs.que.push(function () {
        setUidConfig();
        pbjs.addAdUnits(adUnits);
        pbjs.requestBids();

        $(document).ready(onDocumentReady);
      });
    </script>
  </head>
  <body>
    <h1>Client-Side ${IDENTITY_NAME} SDK Integration Example with Prebid.js</h1>
    <p class="intro">
      This example demonstrates how a content publisher can integrate with ${IDENTITY_NAME} and Prebid.js using the <a href="${DOCS_BASE_URL}/guides/integration-prebid-client-side">${IDENTITY_NAME} Client-Side Integration Guide for Prebid.js</a>, which includes generating ${IDENTITY_NAME} tokens within the browser.
      <strong>Note:</strong> This is a <em>test-only</em> integration environmentâ€”not for production use.
      It does not perform real user authentication or generate production-level tokens.
      Do not use real user data on this page.
    </p>
    <table id="identity_state">
      <tr>
        <td class="label">Ready for Targeted Advertising:</td>
        <td class="value"><pre id="targeted_advertising_ready"></pre></td>
      </tr>
      <tr>
        <td class="label">${IDENTITY_NAME} Advertising Token:</td>
        <td class="value"><pre id="advertising_token"></pre></td>
      </tr>
    </table>
    <div id="test-div">
    </div>
    <div id="login_form" style="display: none" class="form">
      <div class="email_prompt">
        <input
          type="text"
          id="email"
          name="email"
          placeholder="Enter an email address"
          style="border-style: none"
        />
      </div>
      <div><button type="button" class="button" id="login">Generate ${IDENTITY_NAME}</button></div>
    </div>
    <div id="clear_storage_form" style="display: none" class="form">
      <form>
        <button type="button" class="button" id="clear_storage">Clear ${IDENTITY_NAME}</button>
      </form>
    </div>
    </div>
  </body>
</html>
