<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Client-Server <%- identityName %> SDK Integration Example with Prebid.js</title>
    <link rel="stylesheet" type="text/css" href="./app.css" />
    <script async src="./prebid.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      console.log('Initializing example.');

      const identityName = '<%- identityName %>';  // 'UID2' or 'EUID'
      const userIdName = identityName.toLowerCase();  // 'uid2' or 'euid'
      const uidStorageKey = '<%- uidStorageKey %>';
      let currentIdentity = null;

      window.pbjs = window.pbjs || {};
      window.pbjs.que = window.pbjs.que || [];

      function setPrebidConfig() {
        if (!currentIdentity) {
          console.log(`No ${identityName} identity available for Prebid configuration`);
          return;
        }

        window.pbjs.que.push(function() {
          console.log(`Configuring Prebid.js with ${identityName} token`);
          window.pbjs.setConfig({
            userSync: {
              userIds: [{
                name: userIdName,
                value: {
                  [userIdName]: {
                    id: currentIdentity.advertising_token,
                    ...(currentIdentity.refresh_token && {
                      refresh_token: currentIdentity.refresh_token,
                      refresh_from: currentIdentity.refresh_from,
                      refresh_expires: currentIdentity.refresh_expires,
                      identity_expires: currentIdentity.identity_expires,
                      refresh_response_key: currentIdentity.refresh_response_key
                    })
                  }
                }
              }]
            }
          });
          
          console.log(`Prebid ${identityName} configuration set:`, window.pbjs.getUserIds());
        });
      }

      function updateGuiElements() {
        console.log('Updating displayed values.');
        
        const storedToken = localStorage.getItem(uidStorageKey);
        let isOptedOut = false;
        
        if (storedToken) {
          try {
            const tokenData = JSON.parse(storedToken);
            isOptedOut = tokenData.status === 'optout';
          } catch (e) {
            console.log('Could not parse stored token');
          }
        }

        // Update table values
        $('#targeted_advertising_ready').text(currentIdentity && currentIdentity.advertising_token ? 'yes' : 'no');
        $('#login_required').text(currentIdentity && currentIdentity.advertising_token ? 'no' : 'yes');

        if (isOptedOut) {
          $('#advertising_token').text('This email has opted out.');
          $('#prebid_storage').text('N/A (opted out)');
          $('#login_form').hide();
          $('#clear_storage_form').show();
        } else if (currentIdentity && currentIdentity.advertising_token) {
          $('#advertising_token').text(currentIdentity.advertising_token);
          
          // Show localStorage content
          const localStorageValue = localStorage.getItem(uidStorageKey);
          if (localStorageValue) {
            try {
              const parsedToken = JSON.parse(localStorageValue);
              $('#prebid_storage').text(JSON.stringify(parsedToken, null, 2));
            } catch (e) {
              $('#prebid_storage').text(localStorageValue);
            }
          } else {
            $('#prebid_storage').text('No token stored yet.');
          }
          
          $('#login_form').hide();
          $('#clear_storage_form').show();
        } else {
          $('#advertising_token').text('undefined');
          $('#prebid_storage').text('No token stored yet.');
          $('#login_form').show();
          $('#clear_storage_form').hide();
        }
      }

      async function handleLogin() {
        const email = $('#email').val();
        
        if (!email) {
          return;
        }

        console.log(`Generating ${identityName} token for email:`, email);

        try {
          const response = await fetch('/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
          });

          const data = await response.json();

          if (data.status === 'optout') {
            console.log(`${identityName} status: optout`);
            localStorage.setItem(uidStorageKey, JSON.stringify({ status: 'optout' }));
            currentIdentity = null;
            updateGuiElements();
            return;
          }

          if (!response.ok) {
            console.error('Token generation failed:', data);
            return;
          }

          console.log(`${identityName} token received:`, data);

          if (data.identity) {
            currentIdentity = data.identity;
            localStorage.setItem(uidStorageKey, JSON.stringify(currentIdentity));
            
            setPrebidConfig();
          }

          updateGuiElements();

        } catch (error) {
          console.error('Error calling login endpoint:', error);
        }
      }

      function handleClearStorage() {
        console.log(`Clearing ${identityName} storage.`);
        localStorage.removeItem(uidStorageKey);
        currentIdentity = null;
        location.reload();
      }

      function loadStoredIdentity() {
        const storedToken = localStorage.getItem(uidStorageKey);
        if (storedToken) {
          try {
            const tokenData = JSON.parse(storedToken);
            if (tokenData.status !== 'optout' && tokenData.advertising_token) {
              currentIdentity = tokenData;
              console.log(`Loaded stored ${identityName} identity`);
              setPrebidConfig();
            }
          } catch (e) {
            console.error('Failed to parse stored identity:', e);
            localStorage.removeItem(uidStorageKey);
          }
        }
      }

      function onDocumentReady() {
        console.log('Setting up interface handlers.');
        
        $('#login').click(handleLogin);
        $('#clear_storage').click(handleClearStorage);
        
        loadStoredIdentity();
        
        updateGuiElements();
      }

      $(document).ready(onDocumentReady);
    </script>
  </head>
  <body>
    <div class="page-wrapper">
      <div class="main-content">
    <h1>Client-Server <%- identityName %> SDK Integration Example with Prebid.js</h1>
    <p class="intro">
      This example demonstrates how a content publisher can integrate with <%- identityName %> and Prebid.js using the <a href="<%- docsBaseUrl %>/guides/integration-prebid-client-server"><%- identityName %> Client-Server Integration Guide for Prebid.js</a>, where tokens are generated on the server and passed to Prebid.js on the client side.
        </p>

        <h2><%- identityName %> Integration Status</h2>

        <table id="uid_state">
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Ready for Targeted Advertising:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    Indicates whether a valid <%- identityName %> token is present and can be used for personalized ad targeting.
                  </div>
                </div>
              </div>
            </td>
        <td class="value"><pre id="targeted_advertising_ready"></pre></td>
      </tr>
      <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Advertising Token:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The encrypted <%- identityName %> token that is passed to ad systems without exposing raw user identity. It is automatically refreshed by Prebid's <%- identityName %> module in the background when expired.
                  </div>
                </div>
              </div>
            </td>
        <td class="value"><pre id="advertising_token"></pre></td>
      </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Is Login Required?
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    Indicates whether a new <%- identityName %> token needs to be generated. Returns "yes" when no valid identity exists or the current identity has expired.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="login_required"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Prebid Token Storage:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The <%- identityName %> token stored by Prebid in localStorage under the key '<%- uidStorageKey %>'. Prebid uses this for token persistence and automatic refresh.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="prebid_storage"></pre></td>
          </tr>
    </table>

    <div id="login_form" style="display: none" class="form">
          <div class="form-inline">
        <input
          type="text"
          id="email"
          name="email"
          placeholder="Enter an email address"
              class="email-input"
            />
            <button type="button" class="button" id="login">Generate <%- identityName %></button>
          </div>
        </div>

        <div id="clear_storage_form" style="display: none" class="form">
          <button type="button" class="button" id="clear_storage">Clear <%- identityName %></button>
        </div>
      </div>

      <!-- Sidebar for Instructions -->
      <aside class="sidebar">
        <h3>ðŸ“‹ How to Test</h3>
        
        <div class="section">
          <h4>Step 1: Generate <%- identityName %></h4>
          <ul>
            <li>Enter an email address in the input field</li>
            <li>Click "Generate <%- identityName %>" button</li>
            <li>The server generates a token and passes it to Prebid</li>
          </ul>
        </div>

        <div class="section">
          <h4>Step 2: Observe Integration</h4>
          <ul>
            <li>Watch "Ready for Targeted Advertising" change to "yes"</li>
            <li>Check the advertising token appears in the table</li>
            <li>Verify Prebid storage shows token data</li>
          </ul>
        </div>

        <div class="section">
          <h4>Step 3: Test Opt-Out</h4>
          <ul>
            <li>Clear your current identity with the button</li>
            <li>Try the special email: <strong>test@example.com</strong></li>
            <li>Advertising token shows "This email has opted out"</li>
            <li>No token is stored</li>
          </ul>
        </div>

        <div class="section">
          <h4>What's Happening?</h4>
          <ul>
            <li><strong>Server-Side Token Generation:</strong> The server generates <%- identityName %> tokens using your API key and passes them to Prebid</li>
            <li><strong>Prebid Management:</strong> Prebid stores and automatically refreshes <%- identityName %> tokens in the background when expired</li>
            <li><strong>Local Storage:</strong> Prebid stores tokens in localStorage (<%- uidStorageKey %>) for persistence across page loads</li>
            <li><strong>Header Bidding:</strong> Prebid shares <%- identityName %> tokens with bidders automatically</li>
          </ul>
        </div>

        <div class="note">
          <strong>Note:</strong> This is a test-only environment. Do not use real user data.
    </div>
      </aside>
    </div>
  </body>
</html>
