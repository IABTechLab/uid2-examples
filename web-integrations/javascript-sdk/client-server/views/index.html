<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Client-Server <%- identityName %> Integration Example using JavaScript SDK</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/app.css" />
    <link rel="shortcut icon" href="/images/favicon.png" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="<%- uidJsSdkUrl %>"></script>
    <script>
      $(document).ready(() => {
        const sdkName = '<%- uidJsSdkName %>';
        const sdk = window[sdkName];

        function updateGuiElements(state) {
          $('#targeted_advertising_ready').html(sdk.getAdvertisingToken() ? 'yes' : 'no');
          $('#advertising_token').html(String(sdk.getAdvertisingToken()));
          $('#login_required').html(sdk.isLoginRequired() ? 'yes' : 'no');
          $('#identity_state').html(String(JSON.stringify(state, null, 2)));

          if (sdk.isLoginRequired()) {
            $('#login_form').show();
            $('#logout_form').hide();
          } else {
            $('#login_form').hide();
            $('#logout_form').show();
          }
        }

        function onIdentityUpdated(state) {
          updateGuiElements(state);
        }

        $('#logout').click(() => {
          sdk.disconnect();
          updateGuiElements(undefined);
        });

        updateGuiElements(undefined);

        sdk.init({
          baseUrl: '<%- uidBaseUrl %>',
        });

        sdk.callbacks.push(onIdentityUpdated);
      });
    </script>
  </head>
  <body>
    <div class="page-wrapper">
      <div class="main-content">
        <%- include('intro.html'); -%>

        <h2><%- identityName %> Integration Status</h2>

        <table id="uid_state">
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Ready for Targeted Advertising:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    Indicates if a valid <%- identityName %> advertising token is available and ready to be passed to the advertising ecosystem.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="targeted_advertising_ready"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Advertising Token:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The encrypted <%- identityName %> token that is passed to ad systems without exposing raw user identity. It is automatically refreshed by the SDK in the background when expired.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="advertising_token"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Is Login Required?
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    Indicates whether a new <%- identityName %> token needs to be generated.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="login_required"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Identity Callback State:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The complete identity object returned by the SDK. Contains the full <%- identityName %> identity data including refresh tokens and metadata.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="identity_state"></pre></td>
          </tr>
        </table>

        <div id="login_form" style="display: none" class="form">
          <form action="/login" method="POST">
            <div class="form-inline">
              <input
                type="text"
                id="email"
                name="email"
                placeholder="Enter an email address"
                class="email-input"
              />
              <input type="submit" value="Generate <%- identityName %>" class="button" />
            </div>
          </form>
        </div>

        <div id="logout_form" style="display: none" class="form">
          <form>
            <button type="button" class="button" id="logout">Clear <%- identityName %></button>
          </form>
        </div>
      </div>

      <!-- Sidebar for Instructions -->
      <aside class="sidebar">
        <h3>ðŸ“‹ How to Test</h3>
        
        <div class="section">
          <h4>Step 1: Generate <%- identityName %></h4>
          <ul>
            <li>Enter an email address in the input field</li>
            <li>Click "Generate <%- identityName %>" button</li>
            <li>The server generates a token and passes it to the SDK</li>
          </ul>
        </div>

        <div class="section">
          <h4>Step 2: Observe Token State</h4>
          <ul>
            <li>Watch "Ready for Targeted Advertising" change to "yes"</li>
            <li>Check the advertising token appears in the table</li>
            <li>Note "Is Login Required?" becomes "no"</li>
          </ul>
        </div>

        <div class="section">
          <h4>Step 3: Test Opt-Out</h4>
          <ul>
            <li>Clear your current identity with the button</li>
            <li>Try the special email: <code>optout@example.com</code></li>
            <li>Observe no token is generated</li>
          </ul>
        </div>

        <div class="section">
          <h4>What's Happening?</h4>
          <ul>
            <li><strong>Server-Side Token Generation:</strong> The server generates <%- identityName %> tokens using your API key and passes them to the SDK</li>
            <li><strong>Auto-Refresh:</strong> Tokens are automatically refreshed by the SDK in the background when expired</li>
            <li><strong>Local Storage:</strong> The SDK stores identity in localStorage (__uid2_advertising_token or __euid_advertising_token) for persistence across page loads</li>
          </ul>
        </div>

        <div class="note">
          <strong>Note:</strong> This is a test-only environment. Do not use real user data.
        </div>
      </aside>
    </div>
  </body>
</html>
