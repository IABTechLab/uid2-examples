<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Client-Server <%- identityName %> SDK Integration Example with Google Secure Signals</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/app.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="shortcut icon" href="/images/favicon.png" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="<%- uidJsSdkUrl %>"></script>
    <script src="<%- secureSignalsSdkUrl %>"></script>
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

    <script>
      $(document).ready(() => {
        const sdkName = '<%- uidJsSdkName %>';
        let sdk = window[sdkName];
        sdk = sdk || { callbacks: [] };
        
        function updateGuiElements(payload) {
          $("#targeted_advertising_ready").html(
            sdk.getAdvertisingToken() ? "yes" : "no"
          );
          $("#advertising_token").html(String(sdk.getAdvertisingToken()));
          $("#login_required").html(sdk.isLoginRequired() ? "yes" : "no");
          $("#identity_state").html(String(JSON.stringify(payload, null, 2)));
          
          // Update Secure Signals values displayed in the GUI
          updateSecureSignals();

          <% if (isOptout) { %>
          $("#login_form").hide();
          $("#logout_form").hide();
          $("#optout_form").show();
          $("#optout_banner").show();
          $('#googleAdContainer').hide();
          <% } else { %>
          // before token generation, show login form
          if (sdk.isLoginRequired()) {
            $("#login_form").show();
            $("#logout_form").hide();
            $("#optout_form").hide();
            $("#optout_banner").hide();
            $('#googleAdContainer').hide();
          } else {
            // Success case - token generated, show logout form
            $("#login_form").hide();
            $("#logout_form").show();
            $("#optout_form").hide();
            $("#optout_banner").hide();
            $('#googleAdContainer').show();
          }
          <% } %>
        }
        
        function updateSecureSignals() {
          try {
            // Read from localStorage 
            const secureSignalsStorageKey = '<%- secureSignalsStorageKey %>';
            const secureSignalsStorage = localStorage[secureSignalsStorageKey];
            
            const secureSignalsStorageJson = secureSignalsStorage && JSON.parse(secureSignalsStorage);
            
            if (secureSignalsStorageJson && secureSignalsStorageJson[1]) {
              $("#secure_signals_loaded").html("yes");
              $("#secure_signals_value").html(JSON.stringify(secureSignalsStorageJson, null, 2));
            } else {
              $("#secure_signals_loaded").html("no");
              $("#secure_signals_value").html("undefined");
            }
          } catch (e) {
            console.log("Secure signals not yet available", e);
            $("#secure_signals_loaded").html("no");
            $("#secure_signals_value").html("undefined");
          }
        }

        function onIdentityUpdated(eventType, payload) {
          // Allow secure signals time to load
          setTimeout(() => updateGuiElements(payload), 1000);
        }

        $("#logout").click(() => {
          window.googletag.secureSignalProviders.clearAllCache();
          sdk.disconnect();
          window.location.href = '/';
        });
        
        $("#try_another").click(() => {
          window.googletag.secureSignalProviders.clearAllCache();
          sdk.disconnect();
          window.location.href = '/';
        });

        sdk.callbacks.push((eventType, payload) => {
          if (eventType === "SdkLoaded") {
            sdk.init({
              baseUrl: "<%- uidBaseUrl %>",
            });
          }
        });
        
        sdk.callbacks.push((eventType, payload) => {
          if (eventType === 'InitCompleted') {
            <% if (identity !== null && typeof identity !== 'undefined') { %>
            // Server provided an identity, set it
            if (sdk.isLoginRequired()) {
              sdk.setIdentity(<%- JSON.stringify(identity) %>);
            } else {
              // Identity already exists, just update GUI
              updateGuiElements(payload);
            }
            <% } else { %>
            // No identity from server (including opt-out case)
            // SDK will naturally remain in "login required" state
            updateGuiElements(payload);
            <% if (isOptout) { %>
            $("#optout_banner").show();
            <% } %>
            <% } %>
          }
        });
        
        sdk.callbacks.push(onIdentityUpdated);
      });
    </script>
  </head>
  <body>
    <div class="page-wrapper">
      <div class="main-content">
        <%- include('intro.html'); -%>

        <!-- Generate/Clear buttons at the top for easy access -->
        <div id="login_form" style="display: none" class="form top-form">
          <form action="/login" method="POST">
            <div class="form-inline">
              <input
                type="text"
                id="email"
                name="email"
                placeholder="Enter an email address"
                class="email-input"
              />
              <input type="submit" value="Generate <%- identityName %>" class="button" />
            </div>
          </form>
        </div>

        <div id="logout_form" style="display: none" class="form top-form">
          <button type="button" class="button" id="logout">Clear <%- identityName %></button>
        </div>

        <div id="optout_form" style="display: none" class="form top-form">
          <button type="button" class="button" id="try_another">Try Another Email</button>
        </div>

        <div id="optout_banner" style="display: none" class="optout-banner">
          <p>The email address you entered has opted out of <%- identityName %>.</p>
        </div>

        <!-- UID2 Integration Status Section -->
        <h2><%- identityName %> Integration Status</h2>

        <table id="uid_state">
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Ready for Targeted Advertising:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    Indicates whether a valid <%- identityName %> token is present and can be used for personalized ad targeting.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="targeted_advertising_ready"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Advertising Token:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The encrypted <%- identityName %> token that is passed to ad systems without exposing raw user identity. It is automatically refreshed by the SDK in the background when expired.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="advertising_token"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Is Login Required?
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    Indicates whether a new <%- identityName %> token needs to be generated. Returns "yes" when no valid identity exists or the current identity has expired.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="login_required"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Identity Callback State:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The complete identity object returned by the SDK. Contains the full <%- identityName %> identity data including refresh tokens and metadata.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="identity_state"></pre></td>
          </tr>
        </table>

        <!-- Google Secure Signals Section -->
        <h2 class="section-teal">Google Secure Signals Status</h2>
        <p class="section-summary">Secure Signals automatically reads the token from storage and shares it with Google Ad Manager.</p>

        <table id="secure_signals_state">
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Secure Signals Loaded?
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    Indicates whether Google Secure Signals has successfully loaded and stored the <%- identityName %> token. Returns "yes" when signals are available in localStorage.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="secure_signals_loaded"></pre></td>
          </tr>
          <tr>
            <td class="label">
              <div class="tooltip-wrapper">
                Secure Signals Value:
                <div class="tooltip">
                  <span class="tooltip-trigger">?</span>
                  <div class="tooltip-content">
                    The encrypted <%- identityName %> signals stored by Google in localStorage under the key '<%- secureSignalsStorageKey %>'. These signals are shared with Google Ad Manager.
                  </div>
                </div>
              </div>
            </td>
            <td class="value"><pre id="secure_signals_value"></pre></td>
          </tr>
        </table>

        <!-- Video Ad Container - at the bottom -->
        <div id="googleAdContainer" style="display: none">
          <div id="mainContainer">
            <div id="content">
              <video id="contentElement">
                <source src="https://storage.googleapis.com/gvabox/media/samples/stock.mp4"></source>
              </video>
            </div>
            <div id="adContainer"></div>
          </div>
          <button id="playButton">Play</button>
          <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
          <script type="text/javascript" src="ads.js"></script>
        </div>
      </div>

      <!-- Sidebar for Instructions -->
      <aside class="sidebar">
        <h3>ðŸ“‹ How to Test</h3>
        
        <div class="section">
          <h4>Step 1: Generate <%- identityName %></h4>
          <ul>
            <li>Enter an email address in the input field</li>
            <li>Click "Generate <%- identityName %>" button</li>
            <li>The server generates a token and passes it to the SDK</li>
          </ul>
        </div>

        <div class="section">
          <h4>Step 2: View Video Ad</h4>
          <ul>
            <li>Video player appears after successful token generation</li>
            <li>Click "Play" to watch the ad</li>
            <li>Ad request includes <%- identityName %> token via Secure Signals</li>
          </ul>
        </div>

        <div class="section">
          <h4>Step 3: Check Secure Signals</h4>
          <ul>
            <li>Verify "Secure Signals Loaded?" shows "yes"</li>
            <li>Check "Secure Signals Value" displays encrypted token data</li>
            <li>This confirms integration with Google Ad Manager</li>
          </ul>
        </div>

        <div class="section">
          <h4>Step 4: Test Opt-Out</h4>
          <ul>
            <li>Clear your current identity with the button</li>
            <li>Try the special email: <strong>test@example.com</strong></li>
            <li>Observe the opt-out banner appears</li>
            <li>No token or Secure Signals are generated</li>
          </ul>
        </div>

        <div class="section">
          <h4>What's Happening?</h4>
          <ul>
            <li><strong>Server-Side Token Generation:</strong> The server generates <%- identityName %> tokens using your API key and passes them to the SDK</li>
            <li><strong>Auto-Refresh:</strong> Tokens are automatically refreshed by the SDK in the background when expired</li>
            <li><strong>Local Storage:</strong> The SDK stores identity in localStorage (__uid2_advertising_token or __euid_advertising_token) for persistence across page loads</li>
            <li><strong>Google Secure Signals:</strong> Encrypted tokens are stored in localStorage under <%- secureSignalsStorageKey %> and shared with Google Ad Manager</li>
            <li><strong>IMA SDK:</strong> Displays video ads with <%- identityName %> targeting</li>
          </ul>
        </div>

        <div class="note">
          <strong>Note:</strong> This is a test-only environment. Do not use real user data.
        </div>
      </aside>
    </div>
  </body>
</html>
