<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Client-Server <%- identityName %> SDK Integration Example with Google Secure Signals</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/app.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="shortcut icon" href="/images/favicon.png" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="<%- uidJsSdkUrl %>"></script>
    <script src="<%- secureSignalsSdkUrl %>"></script>
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

    <script>
      $(document).ready(() => {
        let callbackCounter = 0;
        const sdkName = '<%- uidJsSdkName %>';
        let sdk = window[sdkName];
        sdk = sdk || { callbacks: [] };
        
        function updateGuiElements(payload) {
          $("#targeted_advertising_ready").html(
            sdk.getAdvertisingToken() ? "yes" : "no"
          );
          $("#advertising_token").html(String(sdk.getAdvertisingToken()));
          $("#login_required").html(sdk.isLoginRequired() ? "yes" : "no");
          $("#update_counter").html(callbackCounter);
          $("#identity_state").html(String(JSON.stringify(payload, null, 2)));
          
          // Update Secure Signals from localStorage (like client-side does)
          updateSecureSignals();

          <% if (isOptout) { %>
          // Opt-out case - always show opt-out form regardless of loginRequired status
          $("#login_form").hide();
          $("#logout_form").hide();
          $("#optout_form").show();
          $("#optout_banner").show();
          $('#googleAdContainer').hide();
          <% } else { %>
          // Non-opt-out case - check if login is required
          if (sdk.isLoginRequired()) {
            $("#login_form").show();
            $("#logout_form").hide();
            $("#optout_form").hide();
            $("#optout_banner").hide();
            $('#googleAdContainer').hide();
          } else {
            // Success case
            $("#login_form").hide();
            $("#logout_form").show();
            $("#optout_form").hide();
            $("#optout_banner").hide();
            $('#googleAdContainer').show();
          }
          <% } %>
        }
        
        function updateSecureSignals() {
          try {
            // Read from localStorage like client-side does
            const secureSignalsStorageKey = '<%- secureSignalsStorageKey %>';
            const secureSignalsStorage = localStorage[secureSignalsStorageKey];
            const secureSignalsStorageJson = secureSignalsStorage && JSON.parse(secureSignalsStorage);
            
            if (secureSignalsStorageJson && secureSignalsStorageJson[1]) {
              $("#secure_signals_loaded").html("yes");
              $("#secure_signals_value").html(JSON.stringify(secureSignalsStorageJson, null, 2));
            } else {
              $("#secure_signals_loaded").html("no");
              $("#secure_signals_value").html("undefined");
            }
          } catch (e) {
            console.log("Secure signals not yet available", e);
            $("#secure_signals_loaded").html("no");
            $("#secure_signals_value").html("undefined");
          }
        }

        function onIdentityUpdated(eventType, payload) {
          if (
            payload?.identity &&
            (eventType === "InitCompleted" || eventType === "IdentityUpdated")
          ) {
            ++callbackCounter;
          }
          // Allow secure signals time to load
          setTimeout(() => updateGuiElements(payload), 1000);
        }

        $("#logout").click(() => {
          window.googletag.secureSignalProviders.clearAllCache();
          sdk.disconnect();
          window.location.href = '/';
        });
        
        $("#try_another").click(() => {
          window.googletag.secureSignalProviders.clearAllCache();
          sdk.disconnect();
          window.location.href = '/';
        });

        sdk.callbacks.push((eventType, payload) => {
          if (eventType === "SdkLoaded") {
            sdk.init({
              baseUrl: "<%- uidBaseUrl %>",
            });
          }
        });
        
        sdk.callbacks.push((eventType, payload) => {
          if (eventType === 'InitCompleted') {
            <% if (identity !== null && typeof identity !== 'undefined') { %>
            // Server provided an identity, set it
            if (sdk.isLoginRequired()) {
              sdk.setIdentity(<%- JSON.stringify(identity) %>);
            } else {
              // Identity already exists, just update GUI
              updateGuiElements(payload);
            }
            <% } else if (isOptout) { %>
            // Opt-out case - set identity to null
            sdk.setIdentity(null);
            $("#optout_banner").show();
            updateGuiElements(payload);
            <% } else { %>
            // No identity from server
            updateGuiElements(payload);
            <% } %>
          }
        });
        
        sdk.callbacks.push(onIdentityUpdated);
      });
    </script>
  </head>
  <body>
    <%- include('intro.html'); -%>
    <p>
      <strong>Note:</strong> This is a <em>test-only</em> integration environmentâ€”not for production
      use. It does not perform real user authentication or generate production-level tokens. Do not
      use real user data on this page.
    </p>
    <div id="googleAdContainer" style="display: none">
      <div id="mainContainer">
        <div id="content">
          <video id="contentElement">
            <source src="https://storage.googleapis.com/gvabox/media/samples/stock.mp4"></source>
          </video>
        </div>
        <div id="adContainer"></div>
      </div>
      <button id="playButton">Play</button>
      <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
      <script type="text/javascript" src="ads.js"></script>
    </div>
    <table id="uid2_state">
      <tr>
        <td class="label">Ready for Targeted Advertising:</td>
        <td class="value"><pre id="targeted_advertising_ready"></pre></td>
      </tr>
      <tr>
        <td class="label"><%- identityName %> Advertising Token:</td>
        <td class="value"><pre id="advertising_token"></pre></td>
      </tr>
      <tr>
        <td class="label">Is <%- identityName %> Login Required?</td>
        <td class="value"><pre id="login_required"></pre></td>
      </tr>
      <tr>
        <td class="label"><%- identityName %> Identity Updated Counter:</td>
        <td class="value"><pre id="update_counter"></pre></td>
      </tr>
      <tr>
        <td class="label"><%- identityName %> Identity Callback State:</td>
        <td class="value"><pre id="identity_state"></pre></td>
      </tr>
      <tr>
        <td class="label">Secure Signals Loaded?</td>
        <td class="value"><pre id="secure_signals_loaded"></pre></td>
      </tr>
      <tr>
        <td class="label">Secure Signals Value:</td>
        <td class="value"><pre id="secure_signals_value"></pre></td>
      </tr>
    </table>
    <div id="optout_banner" style="display: none; border: 3px solid #ffc107; padding: 15px; margin: 20px 0;">
      <p style="margin: 0;">The email address you entered has opted out of <%- identityName %>.</p>
    </div>
    <div id="login_form" style="display: none" class="form">
      <form action="/login" method="POST">
        <div class="email_prompt">
          <input
            type="text"
            id="email"
            name="email"
            placeholder="Enter an email address"
            style="border-style: none"
          />
        </div>
        <div><input type="submit" value="Generate <%- identityName %>" class="button" /></div>
      </form>
    </div>
    <div id="logout_form" style="display: none" class="form">
      <button type="button" class="button" id="logout">Clear <%- identityName %></button>
    </div>
    <div id="optout_form" style="display: none" class="form">
      <button type="button" class="button" id="try_another">Try Another Email</button>
    </div>
  </body>
</html>
